{% extends 'blogs/base.html' %}

{% block title %}发布新帖子 - 我的博客{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card glass">
            <div class="card-header bg-transparent">
                <h1 class="display-5 mb-0 text-gradient">
                    <i class="bi bi-pencil-square animated-icon"></i> 创作新文章
                </h1>
                <p class="text-white-50 mb-0">分享您的想法和知识</p>
            </div>
            <div class="card-body">
                <form method="post" id="postForm">
                    {% csrf_token %}
                    <div class="mb-4">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            <i class="bi bi-type"></i> 文章标题
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger mt-1">
                            {{ form.title.errors }}
                        </div>
                        {% endif %}
                        <div class="form-text text-white-50">
                            一个好的标题能吸引更多读者
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="{{ form.text.id_for_label }}" class="form-label">
                            <i class="bi bi-file-text"></i> 文章内容
                        </label>
                        {{ form.text }}
                        {% if form.text.errors %}
                        <div class="text-danger mt-1">
                            {{ form.text.errors }}
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-white-50">
                                <i class="bi bi-info-circle"></i> 支持Markdown格式
                            </small>
                            <small class="text-white-50">
                                <span id="wordCount">0</span> 字
                            </small>
                        </div>
                    </div>

                    <!-- 预览区域 -->
                    <div class="mb-4" id="previewSection" style="display: none;">
                        <label class="form-label">
                            <i class="bi bi-eye"></i> 预览
                        </label>
                        <div class="card bg-dark text-white">
                            <div class="card-body">
                                <h4 id="previewTitle" class="text-gradient mb-3"></h4>
                                <div id="previewContent" class="content-preview"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2 justify-content-between align-items-center">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-outline-light" onclick="togglePreview()">
                                <i class="bi bi-eye"></i> 预览
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="saveDraft()">
                                <i class="bi bi-save"></i> 保存草稿
                            </button>
                        </div>
                        <div class="d-flex gap-2">
                            <a href="{% url 'blogs:index' %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle"></i> 取消
                            </a>
                            <button type="submit" class="btn btn-primary pulse-on-hover" onclick="showPublishing()">
                                <i class="bi bi-send"></i> 发布文章
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 字数统计
document.addEventListener('DOMContentLoaded', function() {
    const contentField = document.querySelector('textarea[name="text"]');
    const wordCountSpan = document.getElementById('wordCount');
    
    contentField.addEventListener('input', function() {
        const text = this.value;
        const wordCount = text.length;
        wordCountSpan.textContent = wordCount;
        
        // 自动保存到本地存储
        localStorage.setItem('draft_title', document.querySelector('input[name="title"]').value);
        localStorage.setItem('draft_content', text);
        localStorage.setItem('draft_time', new Date().toLocaleString());
    });
    
    // 恢复草稿
    const savedTitle = localStorage.getItem('draft_title');
    const savedContent = localStorage.getItem('draft_content');
    if (savedTitle || savedContent) {
        if (confirm('发现未发布的草稿，是否恢复？')) {
            document.querySelector('input[name="title"]').value = savedTitle || '';
            contentField.value = savedContent || '';
            wordCountSpan.textContent = (savedContent || '').length;
        }
    }
});

// 预览功能
function togglePreview() {
    const previewSection = document.getElementById('previewSection');
    const title = document.querySelector('input[name="title"]').value;
    const content = document.querySelector('textarea[name="text"]').value;
    
    if (previewSection.style.display === 'none') {
        document.getElementById('previewTitle').textContent = title || '无标题';
        document.getElementById('previewContent').innerHTML = content.replace(/\n/g, '<br>') || '暂无内容';
        previewSection.style.display = 'block';
        previewSection.scrollIntoView({ behavior: 'smooth' });
    } else {
        previewSection.style.display = 'none';
    }
}

// 保存草稿
function saveDraft() {
    const title = document.querySelector('input[name="title"]').value;
    const content = document.querySelector('textarea[name="text"]').value;
    
    localStorage.setItem('draft_title', title);
    localStorage.setItem('draft_content', content);
    localStorage.setItem('draft_time', new Date().toLocaleString());
    
    // 显示保存成功提示
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-success border-0 position-fixed top-0 end-0 m-3';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <i class="bi bi-check-circle"></i> 草稿已保存
            </div>
        </div>
    `;
    document.body.appendChild(toast);
    new bootstrap.Toast(toast).show();
    
    setTimeout(() => toast.remove(), 3000);
}

// 发布动画
function showPublishing() {
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalHTML = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 发布中...';
    submitBtn.disabled = true;
    
    // 3秒后恢复按钮状态（防止表单提交失败时按钮卡住）
    setTimeout(() => {
        submitBtn.innerHTML = originalHTML;
        submitBtn.disabled = false;
    }, 3000);
}

// 表单提交后清除草稿
document.getElementById('postForm').addEventListener('submit', function() {
    localStorage.removeItem('draft_title');
    localStorage.removeItem('draft_content');
    localStorage.removeItem('draft_time');
});

// 键盘快捷键
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + S 保存草稿
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveDraft();
    }
    // Ctrl/Cmd + P 预览
    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
        e.preventDefault();
        togglePreview();
    }
});
</script>
{% endblock %}